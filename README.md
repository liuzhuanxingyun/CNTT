# 模块化策略回测框架

这是一个使用 Python 和 Tkinter (ttkbootstrap) 构建的图形化交易策略回测框架。它允许用户方便地对不同的交易策略进行单次回测或参数网格搜索，并查看结果。

## 核心特性

*   **图形化用户界面 (GUI)**: 提供直观易用的界面，无需编写代码即可运行和测试策略。
*   **模块化设计**: 策略的逻辑和UI是分离的。可以轻松添加、修改或禁用任何策略，而无需改动核心代码。
*   **动态加载**: 策略通过 `config.json` 文件进行注册和管理，主程序在启动时动态加载已启用的策略。
*   **两种回测模式**:
    1.  **单次回测**: 对一组特定参数运行策略，并可选择保存详细的每笔交易记录。
    2.  **范围回测 (网格搜索)**: 对多组参数进行批量测试，以寻找最优参数组合，并生成总结报告。
*   **实时日志**: 在界面上实时显示回测过程中的详细日志，方便跟踪进度和发现问题。
*   **异步执行**: 回测任务在独立的线程中运行，避免了界面冻结，并允许用户在回测过程中随时中止任务。
*   **结果保存**: 回测结果（交易列表和网格搜索摘要）会自动保存到 `result` 目录中，方便后续分析。

## 项目结构

```
.
├── config.json         # 策略注册和应用配置
├── main.py             # GUI主程序入口
├── requirements.txt    # 项目依赖
├── data/               # 存放原始K线数据 (.csv)
│   ├── no/             # 未经处理的数据
│   └── ok/             # 已处理过的数据
├── doc/                # 项目文档
├── gui/                # 存放策略的UI模块
│   ├── base_ui.py
│   └── ema_2_atr_ui.py
├── result/             # 存放回测结果
│   ├── many/           # 范围回测的总结报告
│   └── once/           # 单次回测的详细交易记录
├── strategy/           # 存放策略的逻辑模块
│   └── ema_2_atr.py
└── tool/               # 通用工具模块
    └── dataDeal.py
```

*   `main.py`: 应用程序的主窗口和核心逻辑，负责UI布局、事件处理和线程管理。
*   `config.json`: 关键配置文件。在这里注册新的策略，并指定其UI和逻辑模块的路径。
*   `strategy/`: 包含每个策略的核心算法。例如，`ema_2_atr.py` 实现了基于EMA和ATR的交易逻辑。
*   `gui/`: 包含与每个策略对应的参数输入界面。例如，`ema_2_atr_ui.py` 为 `ema_2_atr` 策略提供了参数设置的UI组件。
*   `data/`: 存放CSV格式的K线数据。程序会自动读取 `data/no` 目录下的文件列表。
*   `result/`: 保存所有回测的输出文件。

## 如何使用

1.  **安装依赖**:
    ```bash
    pip install -r requirements.txt
    ```
2.  **准备数据**: 将你的CSV数据文件（例如 `BTCUSDT-15m-2024-01.csv`）放入 `data/no/` 文件夹中。
3.  **运行程序**:
    ```bash
    python main.py
    ```
4.  **执行回测**:
    *   在程序顶部的下拉菜单中选择一个**策略**和一个**数据文件**。
    *   在 **"单次回测"** 选项卡中，设置一组参数，然后点击 **"运行回测"**。
    *   在 **"范围回测"** 选项卡中，为参数设置一个范围或列表（例如 `10-20` 或 `1.0,1.5,2.0`），然后点击 **"运行回测"**。
    *   在回测过程中，可以随时点击 **"中止"** 来停止任务。
5.  **查看结果**:
    *   日志会实时显示在界面下方。
    *   回测完成后，可以点击 **"打开结果目录"** 按钮，直接在文件浏览器中查看生成的CSV报告。

## 如何添加一个新策略

该框架的模块化设计使得添加新策略非常简单：

1.  **创建策略逻辑文件**:
    *   在 `strategy/` 目录下创建一个新的Python文件（例如 `my_strategy.py`）。
    *   在该文件中，实现两个核心函数：
        *   `run_single_backtest(...)`: 用于执行单次回测。
        *   `run_batch_backtest(...)`: 用于执行批量回测。
    *   你可以参考 `strategy/ema_2_atr.py` 作为模板。

2.  **创建策略UI文件**:
    *   在 `gui/` 目录下创建一个新的UI文件（例如 `my_strategy_ui.py`）。
    *   在该文件中，创建一个继承自 `gui.base_ui.BaseStrategyUI` 的类。
    *   实现 `create_frames` 方法来构建你的策略参数输入界面。
    *   实现 `get_single_run_params` 和 `get_grid_search_params` 方法，用于从UI控件中收集参数。
    *   你可以参考 `gui/ema_2_atr_ui.py` 作为模板。

3.  **注册新策略**:
    *   打开 `config.json` 文件。
    *   在 `strategies` 列表中添加一个新的JSON对象来描述你的策略：
      ```json
      {
        "name": "我的新策略",
        "enabled": true,
        "ui_module": "gui.my_strategy_ui",
        "ui_class": "MyStrategyUI",
        "logic_module": "strategy.my_strategy",
        "single_run_func": "run_single_backtest",
        "batch_run_func": "run_batch_backtest"
      }
      ```
4.  **完成**: 重新启动 `main.py`，你的新策略就会自动出现在策略选择的下拉菜单中。
